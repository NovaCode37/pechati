# Безопасность приложения Печати7

Документ описывает реализованные меры защиты и рекомендации по развёртыванию.

---

## Реализованные меры

### 1. CSRF (межсайтовая подделка запросов)

- **Flask-WTF CSRFProtect** включён глобально.
- Во всех формах (включая многошаговый заказ) передаётся `csrf_token`.
- POST-запросы без валидного токена отклоняются.

### 2. XSS (межсайтовый скрипт)

- В шаблонах **Jinja2** по умолчанию экранирует вывод — не используйте `|safe` для пользовательских данных.
- В письмах заказа все поля от пользователя (имя, телефон, сообщение, адрес и т.д.) проходят через **html.escape** перед подстановкой в HTML письма.

### 3. SQL-инъекции

- Используется только **SQLAlchemy ORM**, сырые SQL-запросы с подстановкой пользовательского ввода не применяются.
- Параметры фильтра заказов (`status`) проверяются по белому списку допустимых значений.

### 4. Загрузка файлов

- Разрешены только расширения из **белого списка**: `jpg`, `jpeg`, `png`, `gif`, `pdf`.
- Имя сохраняемого файла формируется как `uuid.hex + расширение` — подмена имени и path traversal исключены.
- Ограничение размера запроса: **5 МБ** (`MAX_CONTENT_LENGTH`).
- Модуль `security.safe_save_upload()` используется для всех загрузок (заказы и админка).

### 5. Валидация многошагового заказа

- **layout_id** и **price_option_id** проверяются на принадлежность текущему товару (нет подмены чужих макетов/цен).
- Длины полей ограничены конфигом: имя, телефон, email, сообщение, адрес, длина JSON параметров.
- Длинные значения обрезаются через `truncate_str()`.

### 6. Ограничение частоты запросов (Rate limiting)

- **Вход в админку** (`/admin/login`): не более **5** попыток с одного IP за **60** секунд.
- **Форма заказа** (`/order`): не более **10** отправок с одного IP за **60** секунд.
- **Многошаговый заказ** (`/order/product/<id>`): не более **15** запросов с одного IP за **60** секунд.

При превышении возвращается **429 Too Many Requests** и показывается страница с просьбой подождать.

### 7. Сессии и cookies

- **SESSION_COOKIE_HTTPONLY** — доступ к сессионной cookie только по HTTP, не из JavaScript.
- **SESSION_COOKIE_SAMESITE = Lax** — защита от CSRF через браузер.
- **SESSION_COOKIE_SECURE** — включается через переменную окружения `SESSION_COOKIE_SECURE=true` (обязательно за HTTPS).
- **PERMANENT_SESSION_LIFETIME** — ограничение времени жизни сессии (1 час).

### 8. HTTP-заголовки безопасности

- **X-Content-Type-Options: nosniff** — отключение MIME-sniffing.
- **X-Frame-Options: SAMEORIGIN** — запрет встраивания в iframe с других сайтов.
- **X-XSS-Protection: 1; mode=block** — включение фильтра XSS в браузере.
- **Referrer-Policy** — ограничение передачи Referer.
- **Permissions-Policy** — отключение ненужных API (геолокация, микрофон, камера).
- **Content-Security-Policy** — ограничение источников скриптов, стилей, шрифтов и изображений.

### 9. Аутентификация администратора

- Пароли хранятся в виде **хеша** (Werkzeug `generate_password_hash`), в БД не хранятся в открытом виде.
- Создание учётной записи администратора по умолчанию **только из переменных окружения**:
  - `ADMIN_USERNAME` и `ADMIN_PASSWORD` задаются при первом запуске (если в БД ещё нет ни одного админа).
- **Не храните логин и пароль в коде.**

### 10. Секретный ключ и режим отладки

- **SECRET_KEY** в продакшене должен задаваться через переменную окружения `SECRET_KEY`.
- При запуске без `DEBUG` и с ключом по умолчанию приложение вызовет **RuntimeError**.
- Режим отладки включается переменной **FLASK_DEBUG=true** (или 1/yes).

---

## Рекомендации по развёртыванию

1. **Обязательно задайте в окружении:**
   - `SECRET_KEY` — длинная случайная строка.
   - `ADMIN_USERNAME` и `ADMIN_PASSWORD` при первом запуске (если нужен начальный админ).
   - На продакшене: `SESSION_COOKIE_SECURE=true`, `FLASK_DEBUG=false`.

2. **HTTPS:** работайте только по HTTPS; за cookie и конфиденциальный трафик отвечайте вы сами или обратный прокси (nginx, cloud).

3. **Файлы загрузок:** каталог `static/uploads` не должен отдаваться как исполняемый; отдавайте файлы только по известным безопасным путям (например, через Flask или nginx с отключённым выполнением).

4. **База данных:** используйте отдельного пользователя БД с минимальными правами (только нужные таблицы/операции). Для продакшена предпочтите PostgreSQL с настроенным доступом и бэкапами.

5. **Почта:** пароль от SMTP храните в переменной окружения `MAIL_PASSWORD`, не в коде и не в репозитории.

6. **Логи:** не логируйте пароли и токены; при необходимости логируйте только факт входа/ошибки.

7. **Обновления:** своевременно обновляйте зависимости (`pip install -U -r requirements.txt`) и следите за объявлениями об уязвимостях (Flask, Werkzeug, SQLAlchemy и т.д.).

---

## Контакты по уязвимостям

Если вы обнаружили уязвимость, сообщите владельцу проекта конфиденциально (не через публичный issue), чтобы была возможность выпустить исправление до раскрытия.
